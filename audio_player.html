<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Audio Player</title>
</head>
<body>
    <audio id="backgroundMusic" loop preload="auto">
        <source src="assets/music/M83 - Outro.mp3" type="audio/mpeg">
    </audio>

    <script>
        const music = document.getElementById('backgroundMusic');
        const startTime = 85; // 1 minute 25 seconds
        const MUSIC_TIME_KEY = 'ourUniverse_musicTime';
        const MUSIC_PLAYING_KEY = 'ourUniverse_isPlaying';
        const LAST_UPDATE_KEY = 'ourUniverse_lastUpdate';
        
        // Restore saved time with compensation for elapsed time
        function restorePosition() {
            const savedTime = parseFloat(localStorage.getItem(MUSIC_TIME_KEY));
            const lastUpdate = parseFloat(localStorage.getItem(LAST_UPDATE_KEY));
            const wasPlaying = localStorage.getItem(MUSIC_PLAYING_KEY) === 'true';
            
            let targetTime = startTime;
            
            if (savedTime && savedTime >= startTime) {
                targetTime = savedTime;
                
                // If music was playing, compensate for time elapsed
                if (wasPlaying && lastUpdate) {
                    const elapsed = (Date.now() - lastUpdate) / 1000;
                    // More aggressive compensation - add elapsed time if less than 5 seconds
                    if (elapsed < 5) {
                        targetTime += elapsed;
                        // Add a small buffer to account for loading delay (0.2 seconds)
                        targetTime += 0.2;
                    }
                }
            }
            
            music.currentTime = targetTime;
            return wasPlaying !== false; // Default to playing
        }
        
        // Save position frequently
        function savePosition() {
            if (!music.paused) {
                localStorage.setItem(MUSIC_TIME_KEY, music.currentTime.toString());
                localStorage.setItem(LAST_UPDATE_KEY, Date.now().toString());
                localStorage.setItem(MUSIC_PLAYING_KEY, 'true');
            }
        }
        
        // Initialize
        const shouldPlay = restorePosition();
        
        // Start playing if should play
        if (shouldPlay) {
            music.play().then(() => {
                window.parent?.postMessage({ type: 'musicStatus', playing: true }, '*');
            }).catch(() => {
                window.parent?.postMessage({ type: 'musicStatus', playing: false }, '*');
            });
        }
        
        // Save position very frequently (every 100ms) while playing
        setInterval(() => {
            if (!music.paused) {
                savePosition();
            }
        }, 100);
        
        // Loop from 1:25 when song ends
        music.addEventListener('ended', () => {
            music.currentTime = startTime;
            savePosition();
            music.play();
        });
        
        // Handle messages from parent
        window.addEventListener('message', (event) => {
            if (event.data.type === 'toggleMusic') {
                if (music.paused) {
                    music.play();
                } else {
                    music.pause();
                }
                savePosition();
                window.parent?.postMessage({ 
                    type: 'musicStatus', 
                    playing: !music.paused 
                }, '*');
            } else if (event.data.type === 'getMusicStatus') {
                // Send current status to parent
                window.parent?.postMessage({ 
                    type: 'musicStatus', 
                    playing: !music.paused 
                }, '*');
            }
        });
        
        // Update parent about status changes
        music.addEventListener('play', () => {
            window.parent?.postMessage({ type: 'musicStatus', playing: true }, '*');
        });
        
        music.addEventListener('pause', () => {
            window.parent?.postMessage({ type: 'musicStatus', playing: false }, '*');
        });
        
        // Save on visibility change
        document.addEventListener('visibilitychange', savePosition);
        window.addEventListener('beforeunload', savePosition);
        window.addEventListener('pagehide', savePosition);
    </script>
</body>
</html>

