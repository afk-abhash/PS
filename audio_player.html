<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Audio Player</title>
</head>
<body>
    <audio id="backgroundMusic" loop preload="auto">
        <source src="assets/music/M83 - Outro.mp3" type="audio/mpeg">
    </audio>

    <script>
        const music = document.getElementById('backgroundMusic');
        const startTime = 155;      // 1 minute 25 seconds
        const MUSIC_TIME_KEY = 'ourUniverse_musicTime';
        const MUSIC_MUTED_KEY = 'ourUniverse_isMuted';
        const LAST_UPDATE_KEY = 'ourUniverse_lastUpdate';
        
        // Restore saved time with compensation for elapsed time
        function restorePosition() {
            const savedTime = parseFloat(localStorage.getItem(MUSIC_TIME_KEY));
            const lastUpdate = parseFloat(localStorage.getItem(LAST_UPDATE_KEY));
            
            let targetTime = startTime;
            
            if (savedTime && savedTime >= startTime) {
                targetTime = savedTime;
                
                // Compensate for time elapsed during page transition
                if (lastUpdate) {
                    const elapsed = (Date.now() - lastUpdate) / 1000;
                    if (elapsed < 5) {
                        targetTime += elapsed + 0.2; // Add buffer for loading
                    }
                }
            }
            
            music.currentTime = targetTime;
        }
        
        // Restore mute state
        const isMuted = localStorage.getItem(MUSIC_MUTED_KEY) === 'true';
        music.muted = isMuted;
        
        // Save position frequently
        function savePosition() {
            localStorage.setItem(MUSIC_TIME_KEY, music.currentTime.toString());
            localStorage.setItem(LAST_UPDATE_KEY, Date.now().toString());
        }
        
        // Initialize - always play
        restorePosition();
        music.play().then(() => {
            window.parent?.postMessage({ type: 'musicStatus', muted: music.muted }, '*');
        }).catch(() => {
            // Browser might block autoplay, try again
            setTimeout(() => music.play(), 100);
        });
        
        // Save position very frequently (every 100ms)
        setInterval(savePosition, 100);
        
        // Loop from 1:25 when song ends
        music.addEventListener('ended', () => {
            music.currentTime = startTime;
            savePosition();
            music.play();
        });
        
        // Handle messages from parent
        window.addEventListener('message', (event) => {
            if (event.data.type === 'toggleMusic') {
                music.muted = !music.muted;
                localStorage.setItem(MUSIC_MUTED_KEY, music.muted.toString());
                window.parent?.postMessage({ 
                    type: 'musicStatus', 
                    muted: music.muted 
                }, '*');
            } else if (event.data.type === 'getMusicStatus') {
                window.parent?.postMessage({ 
                    type: 'musicStatus', 
                    muted: music.muted 
                }, '*');
            }
        });
        
        // Save on page unload
        document.addEventListener('visibilitychange', savePosition);
        window.addEventListener('beforeunload', savePosition);
        window.addEventListener('pagehide', savePosition);
    </script>
</body>
</html>

