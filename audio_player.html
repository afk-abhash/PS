<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Audio Player</title>
</head>
<body>
    <audio id="backgroundMusic" loop preload="auto">
        <source src="assets/music/M83 - Outro.mp3" type="audio/mpeg">
    </audio>

    <script>
        const music = document.getElementById('backgroundMusic');
        const startTime = 85; // 1 minute 25 seconds (85 seconds)
        const MUSIC_TIME_KEY = 'ourUniverse_musicTime';
        const MUSIC_PLAYING_KEY = 'ourUniverse_isPlaying';
        const LAST_UPDATE_KEY = 'ourUniverse_lastUpdate';
        
        // Save position and state
        function savePosition() {
            localStorage.setItem(MUSIC_TIME_KEY, music.currentTime.toString());
            localStorage.setItem(LAST_UPDATE_KEY, Date.now().toString());
            localStorage.setItem(MUSIC_PLAYING_KEY, (!music.paused).toString());
        }
        
        // Initialize
        const playingState = localStorage.getItem(MUSIC_PLAYING_KEY);
        const savedTime = parseFloat(localStorage.getItem(MUSIC_TIME_KEY));
        
        // Set the time
        if (savedTime && savedTime >= startTime) {
            music.currentTime = savedTime;
        } else {
            music.currentTime = startTime;
        }
        
        // Auto-play logic:
        // - If playingState is null (first ever visit): don't play
        // - If playingState is 'true': continue playing (user started music before)
        // - If playingState is 'false': user paused, don't play
        if (playingState === 'true') {
            // Music was playing - compensate for elapsed time and continue
            const lastUpdate = parseFloat(localStorage.getItem(LAST_UPDATE_KEY));
            if (lastUpdate) {
                const elapsed = (Date.now() - lastUpdate) / 1000;
                if (elapsed < 5) {
                    music.currentTime += elapsed + 0.2;
                }
            }
            
            music.play().then(() => {
                window.parent?.postMessage({ type: 'musicStatus', playing: true }, '*');
            }).catch(() => {
                window.parent?.postMessage({ type: 'musicStatus', playing: false }, '*');
            });
        } else {
            // Not playing (either first visit or user paused)
            window.parent?.postMessage({ type: 'musicStatus', playing: false }, '*');
        }
        
        // Save position very frequently (every 100ms) while playing
        setInterval(() => {
            if (!music.paused) {
                savePosition();
            }
        }, 100);
        
        // Loop from 1:25 when song ends
        music.addEventListener('ended', () => {
            music.currentTime = startTime;
            savePosition();
            music.play();
        });
        
        // Handle messages from parent
        window.addEventListener('message', (event) => {
            if (event.data.type === 'toggleMusic') {
                if (music.paused) {
                    // Starting to play - mark as playing in localStorage
                    localStorage.setItem(MUSIC_PLAYING_KEY, 'true');
                    music.play().then(() => {
                        savePosition();
                        window.parent?.postMessage({ 
                            type: 'musicStatus', 
                            playing: true 
                        }, '*');
                    }).catch(() => {
                        window.parent?.postMessage({ 
                            type: 'musicStatus', 
                            playing: false 
                        }, '*');
                    });
                } else {
                    // Pausing
                    music.pause();
                    localStorage.setItem(MUSIC_PLAYING_KEY, 'false');
                    savePosition();
                    window.parent?.postMessage({ 
                        type: 'musicStatus', 
                        playing: false 
                    }, '*');
                }
            } else if (event.data.type === 'getMusicStatus') {
                // Send current status to parent
                window.parent?.postMessage({ 
                    type: 'musicStatus', 
                    playing: !music.paused 
                }, '*');
            }
        });
        
        // Update parent about status changes
        music.addEventListener('play', () => {
            localStorage.setItem(MUSIC_PLAYING_KEY, 'true');
            window.parent?.postMessage({ type: 'musicStatus', playing: true }, '*');
        });
        
        music.addEventListener('pause', () => {
            localStorage.setItem(MUSIC_PLAYING_KEY, 'false');
            savePosition();
            window.parent?.postMessage({ type: 'musicStatus', playing: false }, '*');
        });
        
        // Save on visibility change
        document.addEventListener('visibilitychange', savePosition);
        window.addEventListener('beforeunload', savePosition);
        window.addEventListener('pagehide', savePosition);
    </script>
</body>
</html>

